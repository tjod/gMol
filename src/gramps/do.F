C *************************************************************
C This file contains source code for the gMol computer program
C  Copyright (C) 1981-2010 by TJ O'Donnell and
C  Copyright (C) 2005-2010 gNova, Inc.
C It is unlawful to modify or remove this copyright notice.
C See the accompanying LICENSE file for further information. 
C *************************************************************
      Function DO(TMPLINE)
C
      IMPLICIT NONE
C
      CHARACTER TMPLINE*(*)
C
      CHARACTER*1 COMMA,BLANK,PERCENT
      CHARACTER*52 CMD
      CHARACTER*40 SWITCHES
      CHARACTER*12 VERB
      CHARACTER*10 BLX
      CHARACTER*80 TMPCMD
      Character*6 APPEND
C
#include "UDLIST.FOR"
#include "ERRORS.FOR"
#include "COMMANDS.FOR"
      INTEGER END, BEG, SLASH, I, VSLASH, VSIZE
      CHARACTER*120 COMMAND
      EXTERNAL TRIM
      EXTERNAL INITVAR
      COMMON /CMDLINE/COMMAND
      SAVE /CMDLINE/
C
      DATA COMMA/','/,BLANK/' '/,PERCENT/'%'/
      DATA BLX/' '/
C
#if defined __APPLE__ | defined GFORTRAN
      CALL LOADINITVAR
#endif
      IF(WAITING.NE.0)CALL TELLUSER(PICKWAIT, *999)
      IF(NADVANCE.GT.0)CALL TELLUSER(ADVWAIT, *999)
C
      COMMA=','
      BLANK=' '
      PERCENT='%'
      BLX=' '
C
C   PARSE THE LINE FOR THE COMMAND NAME AND THE ARGS
C   WRITE OUT THE FIXED-UP LINE IF ECHO IS ON.
C   A % AS THE FIRST CHAR OF A LINE FORCES THE LINE
C   NOT TO BE COLLECTED.  %% STARTING THE LINE
C   FORCES IT TO BE COLLECTED BUT NOT INTERPRETED.
C   THAT IS, OF COURSE, IF COLLECT IS ON.
C
C  ! is a comment, !! is just echo this line.
C   AN ASTERISK AS THE FIRST CHARACTER FORCES NOECHO.
C  A > or >> means route output to a file (see SET COMMANDOUT)
C
      COMMAND=TMPLINE
      IF(COMMAND(1:2).EQ.'!!')THEN
        CALL GROUT( COMMAND )
        GOTO 999
      ELSE IF(COMMAND(1:1).NE.'*')THEN
        IF( ECHO.AND.(AGF.EQ.1) )THEN
          CALL GROUT( '!'//COMMAND )
        END IF
        ARGSTART=1
        POINT=1
      ELSE
        ARGSTART=2
        POINT=2
      END IF
      CALL GETSTR(COMMAND,POINT,CMD)
      IF(ERROR.NE.0)CALL TELLUSER(ERROR,*999)
C
C  Check for switches after the command, for example "ROT /LAB"
C
 5    CONTINUE
      IF(POINT.NE.0)THEN
      IF(COMMAND(POINT:POINT).EQ.'/')THEN
        CALL GETSTR(COMMAND, POINT, SWITCHES)
        END=TRIM(CMD)
        TMPCMD=CMD(:END)//SWITCHES    
        CMD=TMPCMD
        GOTO 5
      END IF
      END IF
      END=TRIM(CMD)
C
C   CHECK FOR THE SPECIAL % OR %% START OF LINE
C
      IF(CMD(1:1).EQ.PERCENT)THEN
        IF(CMD(2:2).EQ.PERCENT)THEN
          BEG=3
          GOTO 998
        ELSE
          BEG=2
          SKIPCOLL=.TRUE.
        END IF
      Else If(COMMAND(1:1).EQ.'>')Then
        If(COMMAND(2:2).EQ.'>')Then
          BEG=3
          APPEND='APPEND'
        Else
          BEG=2
          APPEND=' '
        End If
        If(REROUTE.EQ.PENDING)Then
c      Call grout('Writing to file '//RERFILE)
          ERROR=OPENFILE(RERFILE,RFILE,.TRUE.,APPEND)
          If(ERROR.NE.0)CALL Telluser1(NEVER)
          REROUTE=ACTIVE
          Write(RFILE,'(a)')COMMAND(:TRIM(COMMAND))
        Else If(REROUTE.EQ.OFF)Then
          Call grout('No COMMANDOUT file specified.')
        Else If(REROUTE.EQ.ACTIVE)Then
          If(.NOT.DOING) Call Telluser1(NEVER)
        Else
          Call Telluser1(NEVER)
        End If
      ELSE
        BEG=1
      END IF
C
      IF(END.LT.BEG)GOTO 998
C
C   CHECK FOR COMMAND SWITCHES
C
      SLASH=INDEX(CMD,'/')
      IF(SLASH.NE.0)THEN
        SWITCHES=CMD(SLASH:END)
        END=SLASH-1
      ELSE
        SWITCHES=BLANK
      END IF
C
      IF(END.LT.BEG)THEN
        POINT=1
        CALL TELLUSER(CMDERR,*999)
      END IF
C
C   FIND OUT WHICH COMMAND IT IS AND GO TO THE APPROPRIATE SPOT.
C
      VERB=CMD(BEG:END)
      CALL UPCASE(VERB)
      VSIZE=END-BEG+1
      DO 2 I=1,NCMDS
      IF( CMDS(I)(1:VSIZE).EQ.VERB(1:VSIZE) )THEN
        IF(POINT.EQ.0)THEN
          ARGSTART=TRIM(COMMAND)+1
        ELSE
          ARGSTART=POINT
        END IF
        POINT=1
        GOTO (10,20,30,40,50,60,70,80,90,100,110,120,
     &      130,140,150,160,170,180,190,200,210,220,
     &      230,240,250,260,270,280,290,300,310,320,
     &      330,340,350,360,370,380,390,400,410,420,
     &      430,440,450,460,470,480,490)I
      END IF
 2    CONTINUE
C
C   NO COMMAND NAME MATCH
C   RESET POINTER AND TRY TO DO THE FILE NAMED IN THE COMMAND.
C   TRY A .GIN FILE MACRO WITH THIS NAME
C
      ARGSTART=BEG
      POINT=1
      CALL DOFILE(COMMAND(ARGSTART:))
      IF(ERROR.NE.0)CALL TELLUSER(CMDERR,*998)
      GOTO 998
C
C
C   DO THE COMMAND AND RETURN
C
C
 10   CALL ROTATE(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 20   CALL TRANSLATE(COMMAND(ARGSTART:))
      GOTO 998
C
 30   CALL SSCALE(COMMAND(ARGSTART:))
      GOTO 998
C
 40   CALL PERSP(COMMAND(ARGSTART:))
      GOTO 998
C
 50   Continue
      Call FMSAVE
      Call FMHARD
      CALL GET(COMMAND(ARGSTART:),SWITCHES)
      Call FMRESTORE
      GOTO 998
C
 60   CONTINUE
      IF(COMMAND.NE.'EXIT')CALL TELLUSER(CMDERR, *998)
      I = CDONE()
#ifdef USE_SOCK
      CALL SOCKQUIT
      CALL SOCKSERVEREND
#endif
      CALL G0DONE
      STOP 'EXIT'
C
 70   CALL DOFILE(COMMAND(ARGSTART:))
      IF(ERROR.NE.0)CALL TELLUSER(ERROR,*998)
      GOTO 998
C
 80   CALL MMOVE(COMMAND(ARGSTART:))
      GOTO 998
C
 90   CALL SET(COMMAND(ARGSTART:), SWITCHES)
      GOTO 998
C
 100  CALL SHOW(COMMAND(ARGSTART:),SWITCHES)
      SKIPCOLL=.TRUE.
      GOTO 998
C
 110  CALL BLINK(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 120  CALL DASH(COMMAND(ARGSTART:))
      GOTO 998
C
 130  CALL GRAMPS_RENAME(COMMAND(ARGSTART:))
      GOTO 998
C
 140  CALL INTEN(COMMAND(ARGSTART:))
      GOTO 998
C
 150  PPAUSE=.TRUE.
C     if (nadvance.eq.0)Call settimer(0)
      GOTO 998
C
 160  PPAUSE=.FALSE.
C     Call settimer(1)
      GOTO 998
C
 170  CALL RESTART(COMMAND(ARGSTART:),SWITCHES)
      GOTO 999
C
 180  CALL HELP(COMMAND(ARGSTART:))
      SKIPCOLL=.TRUE.
      GOTO 998
C
 190  Continue
      Call FMSAVE
      Call FMHARD
      CALL GETFRAME(COMMAND(ARGSTART:),SWITCHES)
      Call FMRESTORE
      GOTO 998
C
 200  CALL SFRAME(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 210  CALL PLOT(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 220  CALL MAKECOPY(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 230  CALL SYNONYM(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 240  CALL MAKEGROUP(COMMAND(ARGSTART:))
      GOTO 998
C
 250  CALL BBLANK(COMMAND(ARGSTART:))
      GOTO 998
C
 260  CALL INSERT(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 270  CALL REMOVE(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 280  CALL PPICK(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 290  CALL USE(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 300  CALL FREEZE(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 310  CALL RELEASE(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 320  CALL DEASSIGN(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 330  CALL FIX(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 340  CALL DORESET(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 350  CALL CHANGE(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 360  CALL ADVANCE(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 370  CALL SAVE(COMMAND(ARGSTART:),SWITCHES)
      SKIPCOLL=.TRUE.
      GOTO 998
C
 380  CALL TEXT(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 390  CALL DDRAW(COMMAND(ARGSTART:))
      GOTO 998
C
 400  Continue
      If (CMDFROM.eq.SOCKET_OUT) Then
        Call Telluser(NOSOCK, *998)
      End If
      CALL SYSCALL(COMMAND(ARGSTART:))
      GOTO 998
C
 410  CALL DBLANK(COMMAND(ARGSTART:))
      GOTO 998
C
 420  CALL RAYTRACER(COMMAND(ARGSTART:),SWITCHES)
      GOTO 998
C
 430  CALL CCOLOR(COMMAND(ARGSTART:))
      GOTO 998
C
 440  CALL PUTDSK(COMMAND(ARGSTART:))
      GOTO 998
C
 450  CALL LOOP(COMMAND(ARGSTART:))
      GOTO 998
C
 460  CALL FORGET(COMMAND(ARGSTART:))
      GOTO 998
C
 470  CALL SNAP(COMMAND(ARGSTART:), SWITCHES)
      GOTO 998
C
 480  CALL REBUILD(COMMAND(ARGSTART:), SWITCHES)
      GOTO 998
C
 490  CALL JSON(COMMAND(ARGSTART:), SWITCHES)
      GOTO 998
C
C   NORMAL EXIT POINT FOR ALL COMMANDS
C   IF COMMAND HAS NOT REPORTED AN ERROR BY CALLING
C   TELLUSER, THEN LET'S FORGIVE AND FORGET BY SETTING
C   ERROR=0, DENOTING THAT THE COMMAND FINISHED OK.
C   IF COLLECT MODE IS IN EFFECT AND WE'RE NOT
C   INTERPRETING A GIN FILE, WRITE OUT THE COMMAND
C
 998  CONTINUE
      ERROR=0
      IF (COLLECT)THEN
        IF (SKIPCOLL)THEN
          SKIPCOLL=.FALSE.
        ELSE
          IF (.NOT.DOING)
     &  WRITE(CFILE,1000)COMMAND(BEG:TRIM(COMMAND))
        END IF
      END IF
      If(.NOT.DOING .AND. REROUTE.EQ.ACTIVE)Then
        Close(RFILE)
        REROUTE=PENDING
      End If
 1000 FORMAT(A)
C
C   IF WATCH MODE IS IN EFFECT AND A CHANGE HAS
C   OCCURRED IN THE DISPLAY LIST, LET IT BE SHOWN!
C
      IF( OUTTING.GT.0 )THEN
         IF(WATCH.AND.(MCHANGE.OR.TCHANGE.OR.DCHANGE))THEN
           call g0redisplay(AUTOCLEAR)
           TCHANGE=.FALSE.
           MCHANGE=.FALSE.
           DCHANGE=.FALSE.
         END IF
      END IF
C
 999  CONTINUE
      If (nadvance.gt.0) Then
        DO = nadvance
      Else
        If(PPAUSE)Then
          DO=0
        Else
          If (CONT) Then
            DO=-1
          Else
            DO=0
          End If
        End If
      End If

      RETURN
      END
