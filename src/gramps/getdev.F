C *************************************************************
C This file contains source code for the gMol computer program
C  Copyright (C) 1981-2010 by TJ O'Donnell and
C  Copyright (C) 2005-2010 gNova, Inc.
C It is unlawful to modify or remove this copyright notice.
C See the accompanying LICENSE file for further information. 
C *************************************************************
      SUBROUTINE GETDEV(ARG,SPOINT,DEVV)
C
      IMPLICIT NONE
	INTEGER SPOINT, DEVV
C
#include "UDLIST.FOR"
#include "ERRORS.FOR"
C#include "DEVICES.FOR"
      CHARACTER ARG*(*)
      CHARACTER  DEVNAM*2,COMMA*1,BLANK*1
	INTEGER	VPOINT, DEVNUM
      COMMA=','
      BLANK=' '
C
C
C       THIS IS A GRAMPS UTILITY ROUTINE USED TO PARSE THE
C       COMMAND STRING FOR A DEVICE NAME.  IT RETURNS THE
C       BIT MASK CORRESPONDING TO THE DEVICE (DEV) AND
C       UPDATES POINT TO THE NEXT DELIMITER.
C       IF THERE IS AN ERROR, THE ARG POINTER IS UNCHANGED.
C
C       THE DEVNAME MUST BE EXACTLY TWO CHARACTERS LONG!
C       SINCE DEVNAM IS A CHAR*2 (SEE ABOVE),
C       GETSTR WILL ERROR OUT IF THE NEXT COMMAND ARG IS LONGER.
C
C       SAVE THE ARG POINTER
C
      VPOINT=SPOINT
C
      CALL GETSTR(ARG,SPOINT,DEVNAM)
      CALL UPCASE(DEVNAM)
      IF(ERROR.NE.0)GOTO 99
      IF(NPOINT.EQ.0)THEN
        ERROR=INCOMP
        GOTO 99
      END IF
C
      DEVV = 0
      ERROR = 0
C
C       LOOK FOR THE LETTERS D(IAL), K(NOB) OR P(EN).
C
C       IF ITS A DIAL,  ALLOW ONLY ONE NUMBER IN THE RANGE
C       1 TO 8.  DON'T DIE, THOUGH IF ITS 0 OR 9, JUST MAKE
C       A REASONABLE ALTERATION.
C
C
      IF(DEVNAM(1:1).EQ.'D')THEN
        READ(DEVNAM(2:2),1000,ERR=99)DEVNUM
        IF(DEVNUM.GT.8)DEVNUM=8
        IF(DEVNUM.LT.1)DEVNUM=1
        DEVV=ISHFT(DIALS,DEVNUM-1)
C
C       IF ITS A MOUSEX or MOUSEY,  ALLOW ONLY ONE NUMBER IN THE RANGE
C       1 TO 4.
C
      ELSE IF(DEVNAM(1:1).EQ.'X')THEN
        READ(DEVNAM(2:2),1000,ERR=99)DEVNUM
        IF(DEVNUM.GT.4)DEVNUM=4
        IF(DEVNUM.LT.1)DEVNUM=1
        DEVV=ISHFT(MOUSS,DEVNUM-1)
C
      ELSE IF(DEVNAM(1:1).EQ.'Y')THEN
        READ(DEVNAM(2:2),1000,ERR=99)DEVNUM
        IF(DEVNUM.GT.4)DEVNUM=4
        IF(DEVNUM.LT.1)DEVNUM=1
        DEVV=ISHFT(MOUSS,4+DEVNUM-1)
C
      ELSE IF(DEVNAM(1:1).EQ.'S')THEN
        READ(DEVNAM(2:2),1000,ERR=99)DEVNUM
        IF(DEVNUM.GT.8)DEVNUM=8
        IF(DEVNUM.LT.1)DEVNUM=1
        DEVV=ISHFT(SLIDES,DEVNUM-1)
C
      ELSE IF(DEVNAM(1:1).EQ.'V')THEN
        READ(DEVNAM(2:2),1000,ERR=99)DEVNUM
        IF(DEVNUM.EQ.9)DEVNUM=8
        IF(DEVNUM.EQ.0)DEVNUM=1
        DEVV=ISHFT(SPINS,DEVNUM-1)
C
C       ALLOWED DEVICE SPECIFICATIONS ARE PX AND PY and PZ
C       BIT MASKS ARE EXPLAINED IN SUBROUTINE UPDATE.
C
C     ELSE IF(DEVNAM(1:1).EQ.'P')THEN
C       IF(DEVNAM(2:2).EQ.'X')THEN
C         DEVV=TABLETS
C       ELSE
C         IF(DEVNAM(2:2).EQ.'Y')THEN
C           DEVV=TABLETS*2
C         ELSE
C           IF(DEVNAM(2:2).EQ.'Z')THEN
C             DEVV=TABLETS*4
C           ELSE
C             DEVV=0
C           END IF
C         END IF
C       END IF
C
C       IF NONE OF THE APPROPRIATE LETTERS WERE FOUND, ITS
C       NOT A LEGAL DEVICE SPECIFICATION.
C
      ELSE
        DEVV=0
      END IF
C
C       CLEAR THE ERROR FLAG AND RETURN
C       WITH ARG POINTER UPDATED.
C
 99   CONTINUE
      IF(ERROR.EQ.0 .AND. DEVV.EQ.0)ERROR=DEVERR
      IF(ERROR.NE.0)SPOINT=VPOINT
      RETURN
C
 1000 FORMAT(I1)
      END
